<tasks class="mx-2" style="flex-grow:2"></tasks>
<script>
app.on('web-contents-created', function(event, win) {
	console.log(win);
  let dangerFlash;
  let hangWin;
  let alreadyHung = false;
  let icon;
  let $task = $("tasks #" + win.id);
  $task.on('mousedown', function(e) {
    e.preventDefault();
    e.stopImmediatePropagation();
    win.show();
  });
  $task.on('contextmenu', function(e) {
  	e.stopImmediatePropagation();
  	Menu.buildFromTemplate([{
  		label: "New instance",
  		click() {
  			let url = win.getURL();
  			url = url.substring(url.lastIndexOf("/",url.length - "/index.html".length - 1) + 1, url.lastIndexOf("/"));
  			new Window(url)
  		}
  	}, {type: 'separator'}, {
  		label: "Close",
  		click() {win.close()}
  	}]).popup()
  });
  win.webContents.on('did-stop-loading', function() {
  	console.log(win.webContents.browserWindowOptions);
    icon = win.webContents.browserWindowOptions.icon;
    $task.removeClass("loading");
    $task.find("img")[0].src = icon;
  });
	win.webContents.on('will-navigate', ev => {
		ev.preventDefault()
	});
	win.webContents.on("context-menu", function(event, params) {
		if (params.inputFieldType !== "none") {
			var cmenu = [{
				label: "Undo",
				accelerator: "CmdOrCtrl+Z",
				click() {
					win.webContents.send("return-menu", "__undo")
				},
				disabled: !params.editFlags.canUndo
			}, {
				label: "Redo",
				accelerator: "CmdOrCtrl+Shift+Z",
				click() {
					win.webContents.send("return-menu", "__redo")
				},
				disabled: !params.editFlags.canRedo
			}, {
				type: "separator"
			}, {
				label: "Cut",
				accelerator: "CmdOrCtrl+X",
				click() {
					win.webContents.send("return-menu", "__cut")
				},
				disabled: !params.editFlags.canCut
			}, {
				label: "Copy",
				accelerator: "CmdOrCtrl+C",
				click() {
					win.webContents.send("return-menu", "__copy")
				},
				disabled: !params.editFlags.canCopy
			}, {
				label: "Paste",
				accelerator: "CmdOrCtrl+V",
				click() {
					win.webContents.send("return-menu", "__paste")
				},
				disabled: !params.editFlags.canPaste
			}, {
				type: "separator"
			}, {
				label: "Select all",
				accelerator: "CmdOrCtrl+A",
				click() {
					win.webContents.send("return-menu", "__select all")
				},
				disabled: !params.editFlags.canSelectAll
			}];
			var menu = new Menu.buildFromTemplate(cmenu).popup(win)
		}
	})
  win.on('close', function() {
    $task.hide();
  });
  win.on('closed', function() {
    $task.addClass("btn-light").removeClass("btn-danger").fadeOut("200", function() {$task.remove()});
    ipcRenderer.send("close-any-menu");
    clearInterval(dangerFlash);
  });
  win.on('responsive', function() {
    $task.addClass("btn-light").removeClass("btn-danger");
    clearInterval(dangerFlash);
  });
  win.webContents.on('page-favicon-updated', function(e,favs) {
  	console.log(e, favs);
	});
	win.webContents.on('new-window', function(e, url, frame, dispos, opts, adds) {
		console.log(e, url, frame, dispos, opts, adds);
		if(dispos === "new-window") {
			new Window("aos-files", {
				action: "save"
			})
		}
	});
  win.on('unresponsive', function() {
    if(!alreadyHung) {
      hangWin = new Window('aos-process-hang', {
        wid: win.id
      }, {modal: true, parent: win});
      dangerFlash = setInterval(function() {
        $task.toggleClass("btn-light").toggleClass("btn-danger");
      },500)
    } else alreadyHung = true;
  });
  win.on('page-title-updated', function(e, title) {
    $task.attr("title", title);
  });
  win.on('blur', function() {
    $task.removeClass("active");
    ipcRenderer.send("close-any-menu")
  });
  win.on('focus', function() {
    $task.addClass("active");
    ipcRenderer.send("close-any-menu")
  });
  win.on('show', function() {
    $task.show();
    try {$task.css("opacity", "1");} catch(e) {}
  });
  win.on('hide', function() {
    try {$task.css("opacity", "1");} catch(e) {}
  })
})

</script>
