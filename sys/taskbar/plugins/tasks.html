<tasks class="mx-2" style="flex-grow:2"></tasks>
<script>
app.on('browser-window-created', function(event, win) {
	console.log(win);
  if(win.webContents.browserWindowOptions.skipTaskbar === true) return;
  let dangerFlash;
  let hangWin;
  let alreadyHung = false;
  let icon;
  $("tasks").append("<button id='" + win.id + "' class='btn btn-light btn-sm loading'><img src='file://" + app.getAppPath() + "/icons/Loader.png'></button>");
  let $task = $("tasks #" + win.id);
  $task.on('mousedown', function(e) {
    e.preventDefault();
    e.stopImmediatePropagation();
    win.show();
  });
  $task.on('contextmenu', function(e) {
  	e.stopImmediatePropagation();
  	Menu.buildFromTemplate([{
  		label: "New instance",
  		click() {
  			let url = win.getURL();
  			url = url.substring(url.lastIndexOf("/",url.length - "/index.html".length - 1) + 1, url.lastIndexOf("/"));
  			window.new(url)
  		}
  	}, {type: 'separator'}, {
  		label: "Close",
  		click() {win.close()}
  	}]).popup()
  });
  win.webContents.on('did-stop-loading', function() {
  	console.log(win.webContents.browserWindowOptions);
    icon = win.webContents.browserWindowOptions.icon;
    $task.removeClass("loading");
    $task.find("img")[0].src = icon;
  });
	win.webContents.on('will-navigate', ev => {
		ev.preventDefault()
	});
  win.on('close', function() {
    $task.hide();
  });
  win.on('closed', function() {
    $task.addClass("btn-light").removeClass("btn-danger").fadeOut("200", function() {$task.remove()});
    ipcRenderer.send("close-any-menu");
    clearInterval(dangerFlash);
  });
  win.on('responsive', function() {
    $task.addClass("btn-light").removeClass("btn-danger");
    clearInterval(dangerFlash);
  });
  win.webContents.on('page-favicon-updated', function(e,favs) {
  	console.log(e, favs);
	});
	win.webContents.on('new-window', function(e, url, frame, dispos, opts, adds) {
		console.log(e, url, frame, dispos, opts, adds);
		if(dispos === "new-window") {
			window.new("aos-files", {
				action: "save"
			})
		}
	});
  win.on('unresponsive', function() {
    if(!alreadyHung) {
      hangWin = window.new('aos-process-hang', {
        wid: win.id
      }, {modal: true, parent: win});
      dangerFlash = setInterval(function() {
        $task.toggleClass("btn-light").toggleClass("btn-danger");
      },500)
    } else alreadyHung = true;
  });
  win.on('page-title-updated', function(e, title) {
    $task.attr("title", title);
  });
  win.on('blur', function() {
    $task.removeClass("active");
    ipcRenderer.send("close-any-menu")
  });
  win.on('focus', function() {
    $task.addClass("active");
    ipcRenderer.send("close-any-menu")
  });
  win.on('show', function() {
    $task.show();
    try {$task.css("opacity", "1");} catch(e) {}
  });
  win.on('hide', function() {
    try {$task.css("opacity", "1");} catch(e) {}
  })
})

</script>